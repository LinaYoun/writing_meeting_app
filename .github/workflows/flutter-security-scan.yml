name: Flutter Security Scan

 on:
   push:
     branches: [ main ]
   pull_request:
     branches: [ main ]

 jobs:
   security-check:
     runs-on: ubuntu-latest

     defaults:
       run:
         working-directory: code

     steps:
       - name: Checkout repository
         uses: actions/checkout@v4

       # 1. Java 17 설정 (프로젝트 요구사항)
       - name: Set up Java 17
         uses: actions/setup-java@v4
         with:
           distribution: 'temurin'
           java-version: '17'

       # 2. Flutter 환경 설정
       - name: Set up Flutter
         uses: subosito/flutter-action@v2
         with:
           flutter-version: '3.24.0'
           channel: 'stable'
           cache: true

       # 3. 의존성 설치
       - name: Install dependencies
         run: flutter pub get

       # 4. 코드 분석
       - name: Run Flutter analyze
         run: flutter analyze --no-fatal-infos

       # 5. 테스트 실행
       - name: Run tests
         run: flutter test

       # 6. 의존성 취약점 검사
       - name: Check Outdated Packages
         run: flutter pub outdated
         continue-on-error: true

       # 7. 릴리스 빌드 (난독화 포함)
       - name: Build APK with Obfuscation
         run: |
           flutter build apk --release \
             --obfuscate \
             --split-debug-info=./debug-info \
             --dart-define=NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }} \
             --dart-define=NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}

       # 8. Debug symbols 아티팩트 저장 (크래시 분석용)
       - name: Upload debug symbols
         uses: actions/upload-artifact@v4
         with:
           name: debug-symbols
           path: code/debug-info/
           retention-days: 90

       # 9. APK 아티팩트 저장
       - name: Upload APK
         uses: actions/upload-artifact@v4
         with:
           name: release-apk
           path: code/build/app/outputs/flutter-apk/app-release.apk
           retention-days: 30

       # 10. AppSweep 보안 스캔
       - name: Set up Node.js for AppSweep
         uses: actions/setup-node@v4
         with:
           node-version: '20'

       - name: Install AppSweep CLI
         run: npm install -g @guardsquare/appsweep-cli
         working-directory: ${{ github.workspace }}

       - name: Run AppSweep Security Scan
         run: |
           appsweep scan \
             --api-key ${{ secrets.APPSWEEP_API_KEY }} \
             --output appsweep-report.json \
             --format json \
             build/app/outputs/flutter-apk/app-release.apk
         continue-on-error: true

       # 11. 보안 스캔 결과 저장
       - name: Upload AppSweep Report
         uses: actions/upload-artifact@v4
         if: always()
         with:
           name: appsweep-report
           path: code/appsweep-report.json
           retention-days: 30

       # 12. Critical 이슈 발견 시 빌드 실패 처리
       - name: Check for Critical Issues
         run: |
           if [ -f appsweep-report.json ]; then
             if grep -q '"severity":"CRITICAL"' appsweep-report.json; then
               echo "::error::치명적인 보안 문제가 발견되었습니다!"
               cat appsweep-report.json
               exit 1
             fi
           fi
